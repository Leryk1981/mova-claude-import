{
  "kind": "env",
  "id": "env.claude_control_apply_v0",
  "version": "0.1.0",
  "title": "Claude Control Apply v0",
  "intent": {
    "goal": "Разнести значения из ds.claude_control_profile_v0 по файлам Claude Code согласно ds.claude_control_mapping_v0, не ломая рабочий профиль пользователя.",
    "principles": [
      "По умолчанию безопасно: preview (без записи).",
      "Никаких 'строгих отказов' для обычного пользователя: ошибки превращаются в отчёты, а не в блокировку.",
      "Всегда пишем наблюдаемость: apply_report + policy_report + manifest."
    ]
  },
  "inputs": {
    "profile_ref": {
      "description": "Путь к файлу control profile (DS).",
      "path": "mova/ds/control_profile.json"
    },
    "mapping_ref": {
      "description": "Путь к файлу mapping (DS).",
      "path": "mova/ds/control_mapping.json"
    },
    "workspace": {
      "description": "Корень проекта Claude Code (где лежат CLAUDE.md/.claude/.mcp.json).",
      "path": "."
    },
    "apply_mode": {
      "description": "preview | write | write_with_backup. preview = только отчёт/дифф.",
      "value": "preview"
    },
    "apply_target": {
      "description": "Куда разрешено писать: project_only | user_only | local_only | project_and_user | project_and_local | all.",
      "value": "project_only"
    },
    "write_scopes": {
      "description": "Явный список областей, куда разрешена запись. По умолчанию только project.",
      "value": ["project"]
    },
    "backup": {
      "description": "Настройки резервных копий (только для write_with_backup).",
      "enabled": true,
      "dir": "mova/claude_import/v0/backups",
      "strategy": "copy"
    },
    "policy": {
      "description": "Политика применения: что считаем опасным и как реагируем. В v0: только report_only по умолчанию.",
      "default_behavior": "report_only",
      "deny_patterns": [
        "*/.env",
        "*/**/*.pem",
        "*/**/*secret*",
        "*/**/*token*"
      ],
      "allow_paths": [
        "CLAUDE.md",
        ".claude/settings.json",
        ".claude/settings.local.json",
        ".mcp.json",
        "mova/**"
      ],
      "on_denied_write": "report_only",
      "on_parse_error": "report_only",
      "on_missing_target": "report_only"
    },
    "determinism": {
      "description": "Правила детерминированности артефактов.",
      "stable_json": true,
      "stable_sort_keys": true,
      "stable_newlines": "lf"
    }
  },
  "outputs": {
    "result": {
      "ok": true,
      "outcome_code": "OK",
      "summary": "",
      "exit_code_hint": 0,
      "writes_performed": false,
      "changed_files": [],
      "warnings": [],
      "denies": [],
      "errors": []
    },
    "artifacts": {
      "artifact_root": "mova/claude_import/v0",
      "apply_report": "mova/claude_import/v0/reports/apply_report_v0.json",
      "policy_report": "mova/claude_import/v0/reports/input_policy_report_v0.json",
      "diff_summary": "mova/claude_import/v0/reports/diff_summary_v0.json",
      "manifest": "mova/claude_import/v0/reports/control_manifest_v0.json",
      "backup_dir": "mova/claude_import/v0/backups"
    }
  },
  "semantics": {
    "outcome_codes": [
      {
        "code": "OK",
        "meaning": "Применение успешно (или preview успешно). Нет ошибок, возможны предупреждения."
      },
      {
        "code": "WARN",
        "meaning": "Частично применено/проверено: есть предупреждения (например, неизвестные ключи), но профиль остаётся рабочим."
      },
      {
        "code": "PARTIAL",
        "meaning": "Некоторые цели применены, некоторые пропущены из-за отсутствия файлов/парсинга/конфликтов; всё отражено в отчёте."
      },
      {
        "code": "DENY",
        "meaning": "Были попытки записать в запрещённые места; запись не выполнена. Профиль не сломан."
      },
      {
        "code": "ERROR",
        "meaning": "Внутренняя ошибка инструмента. Даже в этом случае должны быть отчёты с деталями."
      }
    ],
    "exit_code_hints": [
      {
        "exit_code": 0,
        "when": "OK/WARN/PARTIAL/DENY в обычном пользовательском режиме",
        "note": "Обычный режим не должен ломать пайплайн пользователя; проблемы = отчёты."
      },
      {
        "exit_code": 1,
        "when": "ERROR",
        "note": "Системная ошибка выполнения инструмента."
      },
      {
        "exit_code": 2,
        "when": "CI strict-mode (не пользователь)",
        "note": "Резервируем для CI-гейтов, если позже понадобится жёсткое падение."
      }
    ]
  },
  "evidence": {
    "must_write": [
      "apply_report_v0.json",
      "input_policy_report_v0.json",
      "control_manifest_v0.json"
    ],
    "should_write": ["diff_summary_v0.json"],
    "apply_report_fields": [
      "run_id",
      "timestamp_utc",
      "apply_mode",
      "apply_target",
      "write_scopes",
      "mapping_version",
      "profile_version",
      "planned_changes",
      "writes_performed",
      "changed_files",
      "skipped",
      "warnings",
      "denies",
      "errors"
    ]
  },
  "compat": {
    "requires": {
      "global_vocab": "global.claude_control_vocab_v0",
      "global_precedence": "global.claude_control_precedence_v0",
      "ds_profile": "ds.claude_control_profile_v0",
      "ds_mapping": "ds.claude_control_mapping_v0"
    },
    "notes": [
      "Этот env не требует mova-spec на уровне данных, но позже может быть привязан к каноническим схемам.",
      "Дефолтная политика: report_only, чтобы инструмент не блокировал работу пользователя."
    ]
  }
}
