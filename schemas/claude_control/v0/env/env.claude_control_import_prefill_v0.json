{
  "kind": "env",
  "id": "env.claude_control_import_prefill_v0",
  "version": "0.1.0",
  "title": "Claude Control Import Prefill v0",
  "intent": {
    "goal": "Считать существующие настройки Claude Code (проект/локально/пользователь) и заполнить ds.claude_control_profile_v0 (prefill), не меняя исходные файлы.",
    "principles": [
      "Никаких side-effects: только чтение + детерминированные отчёты.",
      "Без 'ломающих' режимов по умолчанию: максимум предупреждения и пропуски.",
      "Всегда выдаём понятные артефакты: prefill_profile + prefill_report + policy_report."
    ]
  },
  "inputs": {
    "workspace": {
      "description": "Корень проекта (где лежит CLAUDE.md/.claude/.mcp.json).",
      "path": "."
    },
    "read_scopes": {
      "description": "Какие области читать: project | local | user. По умолчанию читаем только project.",
      "value": ["project"]
    },
    "include_local": {
      "description": "Разрешить чтение локальных настроек (например, settings.local.json).",
      "value": false
    },
    "include_user": {
      "description": "Разрешить чтение пользовательских настроек (если они существуют и доступны).",
      "value": false
    },
    "source_files": {
      "description": "Какие файлы считаем источниками для prefill.",
      "value": {
        "claude_md_project": "CLAUDE.md",
        "claude_settings_project": ".claude/settings.json",
        "claude_settings_local": ".claude/settings.local.json",
        "mcp_project": ".mcp.json"
      }
    },
    "policy": {
      "description": "Политика чтения и редактирования при импорте: мы ничего не записываем в исходники, но должны избегать захвата чувствительных данных.",
      "default_behavior": "report_only",
      "deny_read_patterns": [
        "*/.env",
        "*/**/*.pem",
        "*/**/*secret*",
        "*/**/*token*",
        "*/**/*key*"
      ],
      "allowed_source_paths": [
        "CLAUDE.md",
        ".claude/settings.json",
        ".claude/settings.local.json",
        ".mcp.json"
      ],
      "redaction": {
        "enabled": true,
        "modes": ["inline_token", "key_value", "json_recursive"],
        "hash_alg": "sha256",
        "never_store_values": true
      },
      "on_denied_read": "report_only",
      "on_parse_error": "report_only",
      "on_missing_file": "report_only"
    },
    "determinism": {
      "description": "Правила детерминированности итогов и артефактов.",
      "stable_json": true,
      "stable_sort_keys": true,
      "stable_newlines": "lf",
      "run_id_source": "input_hash_only"
    }
  },
  "outputs": {
    "result": {
      "ok": true,
      "outcome_code": "OK",
      "summary": "",
      "exit_code_hint": 0,
      "prefill_written": false,
      "sources_read": [],
      "warnings": [],
      "denies": [],
      "errors": []
    },
    "artifacts": {
      "artifact_root": "mova/claude_import/v0",
      "prefill_profile": "mova/claude_import/v0/prefill/control_profile_prefill_v0.json",
      "prefill_report": "mova/claude_import/v0/reports/prefill_report_v0.json",
      "policy_report": "mova/claude_import/v0/reports/input_policy_report_v0.json",
      "manifest": "mova/claude_import/v0/reports/prefill_manifest_v0.json",
      "redaction_report": "mova/claude_import/v0/reports/redaction_report_v0.json"
    }
  },
  "semantics": {
    "what_is_prefill": [
      "prefill не 'переписывает' профиль пользователя — он создаёт наш единый control profile из того, что удалось безопасно прочитать.",
      "всё, что не удалось прочитать или нельзя хранить, отражается как WARNING/DENY в отчёте."
    ],
    "outcome_codes": [
      {
        "code": "OK",
        "meaning": "Источники прочитаны, prefill профиль сформирован, критических проблем нет."
      },
      {
        "code": "WARN",
        "meaning": "Профиль сформирован, но есть предупреждения (неизвестные поля/частичные данные)."
      },
      {
        "code": "PARTIAL",
        "meaning": "Часть источников отсутствует/не распарсилась; prefill неполный, но пригоден как старт."
      },
      {
        "code": "DENY",
        "meaning": "Некоторые источники/фрагменты попали под deny_read; они не использованы, всё описано в отчёте."
      },
      {
        "code": "ERROR",
        "meaning": "Внутренняя ошибка инструмента. Даже в этом случае должны быть отчёты."
      }
    ],
    "exit_code_hints": [
      {
        "exit_code": 0,
        "when": "OK/WARN/PARTIAL/DENY",
        "note": "Импорт prefill не должен ломать работу пользователя."
      },
      {
        "exit_code": 1,
        "when": "ERROR",
        "note": "Системная ошибка выполнения."
      }
    ]
  },
  "evidence": {
    "must_write": [
      "prefill_report_v0.json",
      "input_policy_report_v0.json",
      "prefill_manifest_v0.json"
    ],
    "should_write": [
      "control_profile_prefill_v0.json",
      "redaction_report_v0.json"
    ],
    "prefill_report_fields": [
      "run_id",
      "timestamp_utc",
      "workspace",
      "read_scopes",
      "sources_attempted",
      "sources_read",
      "extracted_fields",
      "unknown_fields",
      "warnings",
      "denies",
      "errors"
    ]
  },
  "compat": {
    "requires": {
      "global_vocab": "global.claude_control_vocab_v0",
      "global_precedence": "global.claude_control_precedence_v0",
      "ds_profile": "ds.claude_control_profile_v0",
      "ds_mapping": "ds.claude_control_mapping_v0"
    },
    "notes": [
      "Prefill не требует apply-механики. Это подготовка данных для последующего apply.",
      "Дефолт: читаем только project scope. local/user — только по явному выбору пользователя."
    ]
  }
}
